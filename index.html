<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <link rel="stylesheet" href="main.css">
        <script>
            window.onload = function(){

                let moveByClick = false;

                document.addEventListener("keydown", (e) => {

                    if(e.ctrlKey && e.key == "q"){
                        rotate();
                    }

                    if(e.key === "Delete"){
                        deleteFile();
                    }

                    if(e.key === "ArrowRight"){
                        startFetch(1);
                    }

                    if(e.key === "ArrowLeft"){
                        startFetch(-1);
                    }

                })

                document.getElementById("mouseMove").addEventListener("change", e => {
                    moveByClick = e.target.checked
                })

                document.getElementById("imageArea").addEventListener("mouseup", e => {
                    if(moveByClick){
                        e.preventDefault();
                        if(e.button == 0){
                            startFetch(-1);
                        }

                        if(e.button == 2){
                            startFetch(1);
                        }
                    }
                })

                document.addEventListener("click", (e) =>{

                    if(e.target.id == "deleteBtn"){
                        deleteFile();
                    }

                    if(e.target.id == "reveal"){
                        window.api.send("reveal", null);
                    }

                    if(e.target.id == "openFile"){
                        window.api.send("open", null);
                    }

                    if(e.target.id == "saveFile"){
                        window.api.send("save", null);
                    }

                    if(e.target.id == "restoreFile"){
                        window.api.send("restore", null);
                    }

                    if(e.target.classList.contains("prev")){
                        startFetch(-1);
                    }

                    if(e.target.classList.contains("next")){
                        startFetch(1);
                    }
                })

                document.getElementById("pic").addEventListener("dragover", (e) => {
                    e.preventDefault();
                })
                document.getElementById("pic").addEventListener("drop", (e) =>{

                    e.preventDefault();
                    if(e.dataTransfer.items[0].kind === "file" && e.dataTransfer.items[0].type.includes("image")){
                        dropFile(e.dataTransfer.items[0].getAsFile());
                    }
                })

                init();

            }

            function rotate(){
                const img = document.getElementById("img");
                if(img.classList.contains("rotate")){
                    img.classList.remove("rotate");
                }else{
                    img.classList.add("rotate");
                }
            }

            function prepare(){
                const loader = document.getElementById("loader");

                if(loader.style.display == "block"){
                    return false;
                }

                loader.style.display = "block";
                return true;
            }

            function init(){
                if(prepare()){
                    window.api.send("domready", null);
                }
            }

            function dropFile(file){
                if(prepare()){
                    window.api.send("start", {name:file.name,path:file.path});
                }
            }

            function startFetch(index){
                if(prepare()){
                    window.api.send("fetch", index);
                }
            }

            function deleteFile(){
                if(prepare()){
                    window.api.send("delete", null);
                }
            }

            window.api.receive("afterfetch", data => {
                if(data){
                    const img = document.getElementById("img");
                    img.src = data.path;
                    const dummy = new Image();
                    dummy.src = data.path;
                    dummy.onload = function(){
                        document.title = "PicViewer - " + data.name + "(" + dummy.width + " x " + dummy.height + ")";
                        document.getElementById("loader").style.display = "none";
                    }
                }else{
                    document.getElementById("loader").style.display = "none";
                }

            });

            window.api.receive("onError", data => {
                alert(data);
            })

        </script>
        <meta charset="UTF-8">
        <title>PicViewer</title>
    </head>
    <body>
        <div id="loader">
            <div class="loader">
                <div class="lds-spinner"><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div><div></div></div>
            </div>
        </div>
        <div class="container">
            <div class="menu">
                <div class="header">
                    <div class="open-file">
                        <button class="btn" id="saveFile">Save</button>
                        <button class="btn" id="openFile">Open</button>
                        <button class="btn" id="reveal">Reveal</button>
                        <button class="btn" id="restoreFile">Restore</button>
                    </div>
                    <div id="deleteBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" class="delete" viewBox="0 0 48 48">
                            <defs>
                            <style>
                                .a {
                                fill: none;
                                stroke: #231815;
                                stroke-linecap: round;
                                stroke-linejoin: round;
                                stroke-width: 2px;
                                }
                            </style>
                            </defs>
                            <g>
                            <path class="a" d="M14.5,14.41h19"/>
                            <g>
                                <line class="a" x1="21.25" y1="23.56" x2="21.25" y2="32.37"/>
                                <line class="a" x1="26.75" y1="23.56" x2="26.75" y2="32.37"/>
                            </g>
                            <polygon class="a" points="32.76 17.95 30.8 37.5 17.2 37.5 15.24 17.95 32.76 17.95"/>
                            <polyline class="a" points="20.24 13.92 20.24 10.5 27.76 10.5 27.76 13.92"/>
                            </g>
                        </svg>
                    </div>
                    <div class="option">
                        <span class="label">Mouse only</span>
                        <input type="checkbox" id="mouseMove">
                        <label for="mouseMove" class="toggle"/>
                      </div>
                </div>
            </div>
            <div id="pic" class="main">
                <div class="prev-area prev"><span class="arrow left"></span></div>
                <div id="imageArea" class="image-area">
                    <img id="img" title=""></img>
                </div>
                <div class="next-area next"><span class="arrow right"></span></div>
            </div>
            <div class="menu">
                <div class="footer"></div>
            </div>
        </div>
  </body>
</html>